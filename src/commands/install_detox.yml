description: >
  Installs Android tools & Detox on the MacOS executor, needed to build and test
  Android and iOS applications on the MacOS executor. You need to run this
  before running any other command on those executors.

parameters:
  homebrew_cache:
    description: Should we cache after brew install? Defaults to true
    type: boolean
    default: true
  homebrew_update:
    description: Should we run brew update? Defaults to true
    type: boolean
    default: true

steps:
  - run:
      name: Configure Environment Variables
      command: |
        echo 'export ANDROID_HOME="/usr/local/share/android-commandlinetools"' >> $BASH_ENV
        echo 'export ANDROID_SDK_ROOT="/usr/local/share/android-commandlinetools"' >> $BASH_ENV
        echo 'export PATH="$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/platform-tools:$PATH"' >> $BASH_ENV
        echo 'export QEMU_AUDIO_DRV=none' >> $BASH_ENV
        echo 'export JAVA_HOME=$(/usr/libexec/java_home)' >> $BASH_ENV
        source $BASH_ENV

  - when:
      condition: <<parameters.homebrew_cache>>
      steps:
        - restore_cache:
            key: |
              brew-cache-{{ arch }}-{{ .Environment.CACHE_VERSION }}

  - when:
      condition: <<parameters.homebrew_update>>
      steps:
        - run:
            name: Update brew
            command: brew update >/dev/null

  - run:
      name: Configure Detox Environment
      command: |
        HOMEBREW_NO_AUTO_UPDATE=1 brew tap wix/brew >/dev/null
        HOMEBREW_NO_AUTO_UPDATE=1 brew tap homebrew/cask >/dev/null
        HOMEBREW_NO_AUTO_UPDATE=1 brew install applesimutils >/dev/null
        HOMEBREW_NO_AUTO_UPDATE=1 brew install android-commandlinetools >/dev/null
        touch .watchmanconfig

  - when:
      condition: <<parameters.homebrew_cache>>
      steps:
        - save_cache:
            paths:
              - ~/Library/Caches/Homebrew
            key: |
              brew-cache-{{ arch }}-{{ .Environment.CACHE_VERSION }}
