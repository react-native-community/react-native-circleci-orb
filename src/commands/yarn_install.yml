description: Install Javascript dependencies using Yarn. This command correctly configures the cache for any number of package.json and yarn.lock files.

parameters:
  force_node_version:
    description: If you want a specific version, when you this command.
    type: boolean
    default: false
  node_version:
    description: The version of Node to use. This can be either a major version ("8"), a major and minor ("8.4"), or a fully qualified version ("8.4.1").
    type: string
    default: '10'

steps:
  - when:
      condition: <<parameters.force_node_version_install>>
      steps:
        - set_node_version:
          node_version: <<parameters.node_version>>
      
  - run:
      name: Create cache checksum file
      command: |
        mkdir -p ~/.tmp/checksumfiles
        find . -type f -name 'package.json' -not -path "*node_modules*" -exec cat {} + >> ~/.tmp/checksumfiles/package.json
        find . -type f -name 'yarn.lock' -not -path "*node_modules*" -exec cat {} + >> ~/.tmp/checksumfiles/yarn.lock
  - restore_cache:
      keys:
        - yarn-cache-{{ arch }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}-{{ checksum "~/.tmp/checksumfiles/yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
  - run:
      name: Yarn Install
      command: yarn install --frozen-lockfile --non-interactive --cache-folder ~/.cache/yarn
  - save_cache:
      paths:
        - ~/.cache/yarn
      key: |
        yarn-cache-{{ arch }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}-{{ checksum "~/.tmp/checksumfiles/yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
